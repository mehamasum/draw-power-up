<html>
  <head>
    <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
    <script src="https://trello.com/power-ups/power-up.min.js"></script>
    <!-- jQuery -->
    <script
            src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="content">
      <p>Click on a name to open drawing</p>
      <ul id="attached-list">
      </ul>
      <p class="u-quiet">Claimed attachment urls: <span id="urls"></span></p>
    </div>
    <script>
      /* global TrelloPowerUp */

      var t = TrelloPowerUp.iframe();

      // you can access arguments passed to your iframe like so
      var list = t.arg('arg');

      // passed claimed objects
      /*

       [
       {
       "id":"594c2a338983bd8e09102370",
       "url":"https://www.drawintrello.com?xml=%3CmxGraphModel%20dx%3D%22219%22%20dy%3D%2…%3E%3C%2FmxCell%3E%3C%2Froot%3E%3C%2FmxGraphModel%3E&filename=Drawing2.xml",
       "name":"Drawing2.xml",
       "edgeColor":null,
       "previews":[]
       },
       {
       "id":"594c2a1bbd442b361be6fe95",
       "url":"https://www.drawintrello.com?xml=%3CmxGraphModel%20dx%3D%22219%22%20dy%3D%2…%3E%3C%2FmxCell%3E%3C%2Froot%3E%3C%2FmxGraphModel%3E&filename=Drawing1.xml",
       "name":"Drawing1.xml",
       "edgeColor":null,
       "previews":[]
       }
       ]

       */

      var size = list.length;
      var htmlList = "";
      for(var i=0; i<size; i++) {
        var itemUrl = list[i]['url'];
        var itemName = list[i]['name'];
        htmlList += "<div>" +
                "<p>"+itemName+"</p>" +
                "<button onclick='openDrawing(itemUrl, itemName)'> Open </button>"+
                "</div>"
      }
      $("#attached-list").html(htmlList);

      function openDrawing(url, name) {
         console.log("openDrawing: "+ url +" , "+ name);
      }

      function saveDrawing(url, name) {
        console.log("saveDrawing: "+ url +" , "+ name);
      }

      t.render(function(){
        console.log("rendering section!!!");

        // make sure your rendering logic lives here, since we will
        // recall this method as the user adds and removes attachments
        // from your section
        t.card('attachments')
                .get('attachments')
                .filter(function(attachment){
                  return attachment.url.indexOf('http://www.nps.gov/yell/') == 0;
                })
                .then(function(yellowstoneAttachments){
                  var urls = yellowstoneAttachments.map(function(a){ return a.url; });
                  document.getElementById('urls').textContent = urls.join(', ');
                })
                .then(function(){
                  return t.sizeTo('#content');
                });
      });

    </script>
  </body>
</html>
